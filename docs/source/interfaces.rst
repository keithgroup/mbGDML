==========
Interfaces
==========

Atomic Simulation Environment
=============================

We provide a :class:`calculator <mbgdml.interfaces.ase.mbeCalculator>` for Atomic Simulation Environment (ASE) that enables many routines such as optimization and molecular dynamics.

Examples
--------

Periodic box optimization
^^^^^^^^^^^^^^^^^^^^^^^^^

.. tab-set::

    .. tab-item:: ase-optimize.py

        .. code-block:: python

            import os
            import numpy as np

            from ase import Atoms
            from ase.optimize import BFGS

            from reptar.utils import parse_xyz

            from mbgdml.interfaces.ase import mbeCalculator
            from mbgdml.mbe import mbePredict
            from mbgdml.models import gdmlModel
            from mbgdml.periodic import Cell
            from mbgdml.predictors import predict_gdml
            from mbgdml.descriptors import Criteria, com_distance_sum
            from mbgdml.utils import get_entity_ids, get_comp_ids, atoms_by_number

            # Ensures we execute from script directory (for relative paths).
            WORK_DIR = os.path.dirname(os.path.realpath(__file__))
            os.chdir(WORK_DIR)

            # Conversion factors.
            HARTREE_TO_KCALMOL = 627.5094737775374055927342256  # Psi4 constant
            HARTREE_TO_EV = 27.21138602  # Psi4 constant
            EV_TO_KCALMOL = HARTREE_TO_KCALMOL / HARTREE_TO_EV
            KCALMOL_TO_EV = HARTREE_TO_EV / HARTREE_TO_KCALMOL

            # Load Z and R from XYZ file
            print("Setting up system")
            XYZ_PATH = "./33h2o-10ang-box.xyz"
            Z, _, R = parse_xyz(XYZ_PATH)
            Z = atoms_by_number(Z[0])
            Z = np.array(Z)
            R = np.array(R)

            # Eventually we will make an ASE Atoms object that requires only a single structure.
            if R.ndim == 3:
                R = R[-1]

            # Setup unit cell
            BOX_LENGTH = 10.0  # Angstroms
            MIC_CUTOFF = 5.0  # Maximum value is half of the box length
            cell_v = [[BOX_LENGTH, 0.0, 0.0], [0.0, BOX_LENGTH, 0.0], [0.0, 0.0, BOX_LENGTH]]
            periodic_cell = Cell(cell_v, pbc=True, cutoff=MIC_CUTOFF)

            # Setup fragments
            N_MOLECULES = 33
            entity_ids = get_entity_ids(atoms_per_mol=3, num_mol=N_MOLECULES)
            comp_ids = get_comp_ids(label="h2o", num_mol=N_MOLECULES)

            # Setup ray.
            # Note, this assumes you already ran `ray start --head` on your system's terminal.
            N_WORKERS = 8  # Generally the number of CPU cores to use.

            # Loading mbGDML models.
            print("Setting up mbGDML")
            model_paths = [
                "./1h2o-model-gdml.npz",
                "./2h2o-model-gdml-nbody.npz",
                "./3h2o-model-gdml-nbody.npz",
            ]
            model_comp_ids = [["h2o"], ["h2o", "h2o"], ["h2o", "h2o", "h2o"]]
            model_desc_kwargs = (
                {"entity_ids": get_entity_ids(atoms_per_mol=3, num_mol=1)},
                {"entity_ids": get_entity_ids(atoms_per_mol=3, num_mol=2)},
                {"entity_ids": get_entity_ids(atoms_per_mol=3, num_mol=3)},
            )
            model_desc_cutoffs = (None, 6.0, 10.0)
            model_criteria = [
                Criteria(com_distance_sum, desc_kwargs, cutoff)
                for desc_kwargs, cutoff in zip(model_desc_kwargs, model_desc_cutoffs)
            ]
            models = [
                gdmlModel(path, comp_ids=model_comp_id, criteria=criteria)
                for path, model_comp_id, criteria in zip(
                    model_paths, model_comp_ids, model_criteria
                )
            ]
            mbe_pred = mbePredict(models, predict_gdml, use_ray=True, n_workers=N_WORKERS)

            # Initialize Atoms object under periodic boundary conditions.
            print("Setting up ASE")
            ase_atoms = Atoms(numbers=Z, positions=R, cell=cell_v, pbc=True)

            # Attach ASE calculator
            mbe_calc = mbeCalculator(mbe_pred, e_conv=KCALMOL_TO_EV, f_conv=KCALMOL_TO_EV)
            mbe_calc.directory = WORK_DIR
            mbe_calc.set(entity_ids=entity_ids, comp_ids=comp_ids)
            ase_atoms.calc = mbe_calc

            # Setup logging
            mbe_traj_path = os.path.join(WORK_DIR, "33h2o-10ang-box-opt.traj")

            # Run BFGS optimization
            print("Starting optimization")
            dyn = BFGS(atoms=ase_atoms, trajectory=mbe_traj_path)
            dyn.run(fmax=0.3, steps=150)

            print("Writing XYZ file")
            Z = ase_atoms.get_atomic_numbers()
            R = ase_atoms.get_positions()
            write_xyz(os.path.join(WORK_DIR, "33h2o-10ang-box-opt.xyz"), Z, R)

            print("Done!")

    .. tab-item:: models

        Here are example :download:`1-body <./files/models/first-manuscript/1h2o-model-gdml.npz>`, :download:`2-body <./files/models/first-manuscript/2h2o-model-gdml-nbody.npz>`, and :download:`3-body <./files/models/first-manuscript/3h2o-model-gdml-nbody.npz>` GDML force fields for water.

    .. tab-item:: output

        .. code-block:: text

            Setting up system
            Setting up mbGDML
            2022-12-27 14:22:54,416 INFO worker.py:1342 -- Connecting to existing Ray cluster at address: 10.0.0.249:6379...
            2022-12-27 14:22:54,421 INFO worker.py:1528 -- Connected to Ray cluster.
            Setting up ASE
            Starting optimization
                Step     Time          Energy         fmax
            BFGS:    0 14:23:12   -68518.653019        3.6325
            BFGS:    1 14:23:28   -68520.313458        2.9306
            BFGS:    2 14:23:43   -68525.005044        1.9270
            BFGS:    3 14:23:59   -68527.921969        2.9403
            BFGS:    4 14:24:14   -68529.629667        2.1939
            BFGS:    5 14:24:29   -68530.677248        1.2384
            BFGS:    6 14:24:43   -68531.518250        2.6700
            BFGS:    7 14:24:57   -68532.390131        1.7630
            BFGS:    8 14:25:12   -68532.894844        1.1793
            BFGS:    9 14:25:25   -68533.295726        1.3914
            BFGS:   10 14:25:41   -68533.650620        2.2857
            BFGS:   11 14:25:56   -68534.136271        0.9466
            BFGS:   12 14:26:10   -68534.550863        1.1686
            BFGS:   13 14:26:23   -68535.202815        1.3721
            BFGS:   14 14:26:37   -68535.409146        1.3152
            BFGS:   15 14:26:51   -68535.712958        0.6730
            BFGS:   16 14:27:05   -68535.998454        1.1208
            BFGS:   17 14:27:19   -68536.201667        1.1206
            BFGS:   18 14:27:32   -68536.399319        0.9485
            BFGS:   19 14:27:46   -68536.592457        1.0734
            BFGS:   20 14:27:59   -68536.840849        1.0585
            BFGS:   21 14:28:13   -68537.063691        1.1978
            BFGS:   22 14:28:26   -68537.177919        0.6039
            BFGS:   23 14:28:40   -68537.293836        0.6565
            BFGS:   24 14:28:53   -68537.462942        1.0372
            BFGS:   25 14:29:06   -68537.601761        0.9097
            BFGS:   26 14:29:20   -68537.711911        0.5418
            BFGS:   27 14:29:33   -68537.832103        0.6809
            BFGS:   28 14:29:46   -68537.960451        0.9854
            BFGS:   29 14:30:00   -68538.092724        0.6915
            BFGS:   30 14:30:13   -68538.129976        0.8288
            BFGS:   31 14:30:27   -68538.232220        0.5363
            BFGS:   32 14:30:40   -68538.314060        0.7093
            BFGS:   33 14:30:54   -68538.432156        0.5956
            BFGS:   34 14:31:07   -68538.517603        0.5605
            BFGS:   35 14:31:21   -68538.583234        0.5412
            BFGS:   36 14:31:34   -68538.661859        0.6706
            BFGS:   37 14:31:48   -68538.735478        0.5208
            BFGS:   38 14:32:01   -68538.788335        0.4956
            BFGS:   39 14:32:15   -68538.837806        0.3772
            BFGS:   40 14:32:28   -68538.892548        0.4071
            BFGS:   41 14:32:42   -68538.935573        0.3978
            BFGS:   42 14:32:55   -68538.977582        0.4096
            BFGS:   43 14:33:09   -68539.035139        0.3623
            BFGS:   44 14:33:22   -68539.082973        0.2792
            Writing XYZ file
            Done!
    
    .. tab-item:: 33h2o-10ang-box.xyz

        .. code-block:: text

            99
            Built with Packmol                                             
            O            4.448288        1.208086        2.746892
            H            3.536319        0.983195        2.955685
            H            4.512732        1.100818        1.792849
            O            3.948733        1.316616        6.793027
            H            3.853295        2.273996        6.806119
            H            3.250261        1.010757        6.206132
            O            8.520903        5.980787        8.300956
            H            8.028530        5.491196        8.967086
            H            7.856720        6.256644        7.661720
            O            3.049999        7.894083        5.432018
            H            3.435076        7.885144        6.313774
            H            3.536801        7.220277        4.947388
            O            5.809833        8.758480        8.132870
            H            5.089620        9.004536        7.544135
            H            5.378026        8.335505        8.881531
            O            8.959022        3.799450        7.522505
            H            8.105949        4.116766        7.210358
            H            9.085442        2.958855        7.071643
            O            6.721564        7.502117        2.659343
            H            7.427039        7.328975        3.290362
            H            5.947224        7.678085        3.202749
            O            6.394610        5.178943        6.110874
            H            5.559335        5.040733        5.653631
            H            7.067268        4.938945        5.466056
            O            5.896766        5.537198        8.219439
            H            5.938502        6.136762        8.970864
            H            6.029607        4.662834        8.598515
            O            1.024728        3.675127        4.249228
            H            1.003345        4.457946        4.808331
            H            1.570091        3.927930        3.497877
            O            8.331325        8.604727        7.490032
            H            8.408019        8.327100        8.408128
            H            8.943106        8.036109        7.012272
            O            7.645795        2.445103        8.627870
            H            8.006798        1.618302        8.962437
            H            6.764088        2.497423        9.009594
            O            1.012860        6.707380        3.907940
            H            1.849672        6.236197        3.848027
            H            0.985880        7.041051        4.810045
            O            1.084508        1.394258        4.855807
            H            1.918032        1.161958        4.434934
            H            1.333853        1.960597        5.592656
            O            8.159789        8.976462        1.691952
            H            7.491096        8.999820        1.000459
            H            8.996631        8.929985        1.219307
            O            2.855454        5.441794        6.042908
            H            2.200437        6.069425        6.363674
            H            3.644715        5.628257        6.560745
            O            1.114017        1.632434        2.395827
            H            1.342919        1.006683        1.701638
            H            1.006312        2.472781        1.939675
            O            1.011581        8.889374        3.472575
            H            1.546404        8.833852        2.674616
            H            1.646378        9.034334        4.181009
            O            4.188229        3.228318        4.365115
            H            3.885257        3.724723        5.131696
            H            4.095151        2.305409        4.620915
            O            8.647352        6.535042        1.015165
            H            9.010228        6.684375        1.893731
            H            7.801287        6.104299        1.171665
            O            1.020174        8.071019        8.119338
            H            1.055278        8.326201        7.192241
            H            1.048206        8.903140        8.601673
            O            9.018138        6.527312        5.336616
            H            8.117733        6.866508        5.345254
            H            8.982312        5.757471        4.760492
            O            7.337606        1.034847        6.955019
            H            8.170080        1.054660        6.472884
            H            6.661836        1.134434        6.277320
            O            4.179361        5.717711        2.552372
            H            3.333954        6.050423        2.235436
            H            3.953449        5.145917        3.292557
            O            3.645005        4.397988        8.472033
            H            3.928850        5.095361        9.071167
            H            3.373635        3.677386        9.049050
            O            6.277071        2.534167        4.639107
            H            7.162709        2.904082        4.707426
            H            6.194422        2.270085        3.717539
            O            4.668657        1.829959        8.805258
            H            5.173153        1.037956        8.595323
            H            3.783191        1.508985        9.002196
            O            6.031231        4.470176        3.585363
            H            6.031530        4.193076        2.663911
            H            6.120551        5.427629        3.551246
            O            1.586099        1.466764        8.924615
            H            0.994265        2.161784        8.620414
            H            1.835234        0.992591        8.125271
            O            2.995187        7.565108        8.947375
            H            2.925579        6.882351        8.272945
            H            3.193377        8.370016        8.458805
            O            1.610803        4.059269        7.707480
            H            1.993036        3.406308        7.113007
            H            0.945326        4.509693        7.178220
            O            6.288949        7.378714        6.467604
            H            6.605633        8.230985        6.152638
            H            5.488556        7.213994        5.959572
            O            8.406661        2.835502        2.118919
            H            8.750038        3.656909        2.483939
            H            8.229177        2.283705        2.886954

    .. tab-item:: 33h2o-10ang-box-opt.xyz

        .. code-block:: text

            99
            
            O    4.4702331747    1.2799283702    2.6523502434
            H    3.5326113050    1.2939294119    2.3916253180
            H    4.9413698026    0.9196341436    1.8939906198
            O    4.1100836276    1.3750440732    6.1577041994
            H    4.0921880153    1.7319839019    7.0592059249
            H    3.1850778845    1.1767816262    5.9281018697
            O    8.3632179356    6.3274637972    8.8095227029
            H    8.7580001494    5.4510805301    8.9187449857
            H    8.1969627459    6.3861856656    7.8598459474
            O    3.5173580085    8.3989262920    5.4626603586
            H    3.2936721939    8.1135100406    6.3630134387
            H    3.5381717076    7.5584419524    4.9801014655
            O    5.7275322556    9.2330243847    8.7380092518
            H    5.4781516025    9.6776900584    7.9207381152
            H    5.0871073845    8.5102962171    8.8229387080
            O    9.1473323649    3.8518179597    6.7074234289
            H    8.2578002579    3.5676422583    6.9627363085
            H    9.7172116692    3.1066841493    6.9158264489
            O    6.5894397302    7.5449454813    2.6595091736
            H    7.1207806297    7.8949921737    3.3872758924
            H    5.6939330400    7.6783191358    2.9957178265
            O    6.5333487724    4.3515810258    5.9662033202
            H    5.6427993061    4.7196954470    5.8749393778
            H    6.9567690322    4.6973638864    5.1618265531
            O    5.6538580387    5.2209657616    9.0797842098
            H    6.3050775256    5.8610741394    9.4052624714
            H    6.1574295314    4.6906140325    8.4450534247
            O    0.7738322835    3.4740122607    3.7462141849
            H    0.4515118806    4.3798745253    3.8500872356
            H    1.7316983587    3.5559223069    3.9574986362
            O    8.5076352130    8.9717987665    7.2001322994
            H    8.4701267786    8.7674589323    8.1430590314
            H    9.3348179502    8.5920425613    6.8798071017
            O    7.5488372600    2.7595616410    9.1106588790
            H    7.4677202350    1.9715312210    8.5493578328
            H    6.7223052816    2.7549973486    9.6113886852
            O    1.1975088898    6.2758558885    4.4967576104
            H    1.8793319111    6.1819331467    3.8029008061
            H    0.9175385822    7.1950130729    4.3676228040
            O    1.3300943464    0.9428254534    5.4488412299
            H    1.3247989471    0.8144904616    4.4890217200
            H    0.9732063425    1.8411337999    5.5157135715
            O    8.5071975472    9.4669184758    1.4995000823
            H    7.6934368723    8.9480381967    1.4987284208
            H    9.0480086074    9.0350374078    0.8290425486
            O    3.3614643531    5.4803831606    6.2030421385
            H    2.4660323269    5.6831102946    5.8720379222
            H    3.2588246730    5.1594886636    7.1216791313
            O    1.5642826994    1.3662052297    2.3041540084
            H    1.0005012952    1.0226530745    1.6002686287
            H    1.1718894000    2.2241965472    2.5665927697
            O    1.2250969408    9.0894563801    3.7868512067
            H    1.3154217748    9.4043471221    2.8793844373
            H    2.0999259407    9.1820204740    4.1991292000
            O    3.3726588360    3.5590466224    4.2857274745
            H    3.4670697728    3.9958749356    5.1522100432
            H    3.8715118025    2.7289773940    4.3378528694
            O    8.9092351503    6.0639626321    1.2428135459
            H    9.1278917113    6.4830727332    2.0857247014
            H    7.9970331380    6.3392376211    1.0942589183
            O    0.8654200395    8.5580246741    7.8108971636
            H    0.5282680709    8.6136296473    6.9079623669
            H    0.1326998395    8.8099393398    8.3857750411
            O    8.9389766993    6.4849155327    4.7260763747
            H    8.1072100823    6.7377834199    5.1634858084
            H    9.3009404757    5.7544604753    5.2476448283
            O    7.2963782062    0.6559350118    7.1024864729
            H    8.0660768388    0.3503766571    6.6090712151
            H    6.7218717862    0.9616251197    6.3817260131
            O    3.4783738960    6.0316414607    2.9819978423
            H    3.5539063931    6.0515611590    2.0174438880
            H    3.8670076923    5.1644847082    3.2386040814
            O    3.1466665390    4.4834423540    8.7862162286
            H    4.0172069271    4.8547274703    9.0715114154
            H    3.2594756305    3.5463003738    9.0075345876
            O    6.8775509966    1.7654790482    4.4238131992
            H    6.6458137470    2.6153896314    4.8347592080
            H    6.0750188885    1.5464007446    3.9194307326
            O    4.7259115274    1.6264703022    9.0584615415
            H    5.2106767121    0.8390631608    8.7752298843
            H    3.8657929547    1.2960482412    9.3640072896
            O    6.1501079936    4.7236783753    3.0621698366
            H    6.8182090895    4.1559298166    2.6242667104
            H    6.4656064310    5.6168519895    2.8524374387
            O    1.8451832123    1.3662783050    8.9423902969
            H    1.2481450827    2.0792078343    8.6636341819
            H    1.7472858981    0.7250411102    8.2264561212
            O    3.3820411327    7.6342947209    8.8001438345
            H    2.8693643842    6.8179236009    8.8580312515
            H    2.7184209822    8.3404304475    8.7694525268
            O    0.8230818787    3.5438561039    7.3684736488
            H    1.5186965409    4.0876914027    7.7692939452
            H    0.1237308930    4.1625983191    7.1288269409
            O    6.6260333595    7.6722586118    5.7563420547
            H    7.1014611425    8.3009640208    6.3408878398
            H    5.6844289443    7.8541182030    5.8590150464
            O    8.0389911506    3.0369613138    2.0494467163
            H    8.8893859967    3.4565155786    1.8594050789
            H    8.1414701513    2.4861514460    2.8419700885

